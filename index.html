<!DOCTYPE html>
<html>
<head>
    <title>HAR 2 Swagger</title>
    <style type="text/css">
        form { height: 600px; width: 100%; padding: 2em; box-sizing: border-box; }
        textarea { width: 40%; height: 90%; display: inline-block; border: 1px dashed black; }
    </style>
</head>
<body>
    <form>
        <p>HAR goes on the left and swagger comes out on the right.</p>
        <textarea id="har" placeholder="HAR"></textarea>
        <textarea id="swagger" placeholder="SWAGGER" readonly></textarea>
    </form>
    <script>
        window.addEventListener('DOMContentLoaded', function () {
            var $har = document.getElementById('har'),
                $swagger = document.getElementById('swagger');

            $har.addEventListener('change', function () {
                try {
                    var swagger = new har2Swagger($har.value);
                     $swagger.value = JSON.stringify(swagger, null, 4);
                } catch (e) {
                    alert('failed to convert har to swagger ' + e.message);
                }
            });
        });
    </script>
    <script>
        function har2Swagger(har) {
            if (typeof har === 'string') {
                har = JSON.parse(har);
            }

            var swagger = {
                swagger: '2.0',
                info: {
                    version: '1.0',
                    title: 'generated by har2Swagger',
                    description: 'generated by har2Swagger'
                },
                host: '',
                basePath: '/',
                schemes: [],
                paths: {},
                definitions: {}
            };

            if (!(har && har.log && har.log.entries && har.log.entries.length >= 0)) {
                throw new Error('invalid har');
            }

            var entries = har.log.entries.filter(entry => {
                return entry && entry.request && entry.request.method && entry.request.url && (entry.request.url.indexOf('http://') === 0 || entry.request.url.indexOf('https://') === 0) && entry.response;
            });

            entries.forEach(entry => {
                entry.request._parsedUrl = parseUrl(entry.request.url);
                addSchemeFromEntry(entry);
                addHostFromEntry(entry);
                addPathFromEntry(entry);
            });

            return swagger;

            function addSchemeFromEntry(entry) {
                var protocol = entry.request._parsedUrl.protocol;
                if (swagger.schemes.indexOf(protocol) === -1) {
                    swagger.schemes.push(protocol);
                }
            }

            function addHostFromEntry(entry) {
                if (!swagger.host) {
                    swagger.host = entry.request._parsedUrl.hostname;
                }
            }

            function addPathFromEntry(entry) {
                if (entry.request._parsedUrl.hostname !== swagger.host) {
                    throw new Error(entry.request._parsedUrl.hostname + ' is diffrent from ' + swagger.host);
                }

                var request = entry.request,
                    parsedUrl = request._parsedUrl,
                    path = swagger.paths[parsedUrl.pathname];

                if (!path) {
                    path = swagger.paths[parsedUrl.pathname] = {};
                }

                if (path[request.method]) {
                    throw new Error('duplicate method ' + request.method + ' for path ' + request.url);
                }

                path[request.method.toLowerCase()] = getOperationFromEntry(entry);
            }

            function getOperationFromEntry(entry) {
                var request = entry.request,
                    parsedUrl = request._parsedUrl,
                    operation = {
                        tags: [],
                        summary: request.method + ' ' + parsedUrl.pathname,
                        description: request.method + ' ' + parsedUrl.pathname,
                        operationId: getOperationIdFromEntry(entry),
                        consumes: getOperationConsumesFromEntry(entry),
                        parameters: getParametersFromEntry(entry),
                        produces: getOperationProducesFromEntry(entry),
                        responses: getResponseFromEntry(entry),
                        deprecated: false,
                        'x-ms-visibility': 'important'
                    };
                return operation;
            }

            function getOperationIdFromEntry(entry) {
                var request = entry.request;
                return request.method + request._parsedUrl.pathname;
            }

            function getOperationConsumesFromEntry(entry) {
                var consumes = [],
                    request = entry.request;
                if (request.postData) {
                    var mimeType = request.postData.mimeType;

                    if (mimeType.indexOf('application/json') >= 0 ||
                        mimeType.indexOf('text/javascript') >= 0) {
                        consumes.push(mimeType);
                    } else if (mimeType.indexOf('application/x-www-form') >= 0) {
                        consumes.push(mimeType);
                    }
                }

                return consumes;
            }

            function getOperationProducesFromEntry(entry) {
                var produces = [],
                    response = entry.response;
                if (response.headers && response.headers.length > 0) {
                    response.headers.forEach(header => {
                        if (header.name.toUpperCase() === 'CONTENT-TYPE') {
                            produces.push(header.value);
                        }
                    });
                }
                return produces;
            }

            function getResponseFromEntry(entry) {
                var response = entry.response,
                    result = {},
                    resultStatus = {
                        description: response.statusText,
                        schema: getResponseSchemaFromEntry(entry)
                    };

                result[response.status.toString()] = resultStatus;

                return result;
            }

            function getResponseSchemaFromEntry(entry) {
                var response = entry.response;
                try {
                    if (response && response.content && (response.content.mimeType.indexOf('application/json') >= 0 || response.content.mimeType.indexOf('text/javascript') >= 0))  {
                        var json = JSON.parse(response.content.text);
                        return generateResponseSchema(json);
                    }
                } catch (e) {
                    console.error(e);
                    return { error: 'failed to create response schema' };
                }
                return {};
            }

            function parseUrl(url) {
                var a = document.createElement('a');
                a.href = url;
                return {
                    protocol: a.protocol.split(':')[0],
                    hostname: a.hostname,
                    port: a.port,
                    pathname: a.pathname,
                    search: a.search,
                    hash: a.hash,
                    host: a.host
                };
            }

            function isArray(obj) {
                return Object.prototype.toString.call(obj) === '[object Array]';
            }

            function isInteger(obj) {
                return Number(obj) === obj && obj % 1 === 0;
            }

            function isFloat(obj) {
                return Number(obj) === obj && obj % 1 !== 0;
            }

            function isString(obj) {
                return typeof obj == "string" || (typeof obj == "object" && obj.constructor === String);
            }

            function isBoolean(obj) {
                return obj === true || obj === false;
            }

            function isNull(obj) {
                return obj === null;
            }

            function generateResponseSchema(obj, key) {
                if (isNull(obj)) {
                    return {
                        type: 'object',
                        properties: {}
                    };
                } else if (isInteger(obj)) {
                    return {
                        type: 'integer',
                        description: key || '',
                        'x-ms-summary': key || ''
                    };
                } else if (isFloat(obj)) {
                    return {
                        type: 'decimal',
                        description: key || '',
                        'x-ms-summary': key || ''
                    };
                } else if (isString(obj)) {
                    return {
                        type: 'string',
                        description: key || '',
                        'x-ms-summary': key || ''
                    };
                } else if (isBoolean(obj)) {
                    return {
                        type: 'boolean',
                        description: key || '',
                        'x-ms-summary': key || ''
                    };
                } else if (isArray(obj)) {
                    var arraySchema = {
                        type: 'array',
                        items: obj.length > 0 ? generateResponseSchema(obj[0]) : {}
                    };
                    return arraySchema;
                } else {
                    // obj is Object
                    var objSchema = {
                        type: 'object',
                        properties: {}
                    };
                    Object.keys(obj).forEach(key => {
                        objSchema.properties[key] = generateResponseSchema(obj[key], key);
                    });
                    return objSchema;
                }
            }

            function getParametersFromEntry(entry) {
                var request = entry.request,
                    parameters = []
                        .concat(getQueryStringParametersFromEntry(entry))
                        .concat(getRequestBodyParametersFromEntry(entry));

                return parameters;
            }

            function getQueryStringParametersFromEntry(entry) {
                var request = entry.request,
                    parameters = [];

                if (request.queryString) {
                    request.queryString.forEach(qs => {
                        var schema = generateValueSchema(qs.value);
                        parameters.push({
                            name: qs.name,
                            in: 'query',
                            description: qs.name,
                            'x-ms-summary': qs.name,
                            type: schema.type,
                            required: !!schema.required
                        });
                    });
                }

                return parameters;
            }

            function getRequestBodyParametersFromEntry(entry) {
                var request = entry.request,
                    parameters = [];

                if (request.postData && request.postData.text) {
                    if (request.postData.mimeType.indexOf('application/x-www-form-') >= 0) {
                        var segements = request.postData.text.split('&');
                        segements.forEach(segement => {
                            var kvp = segement.split('='),
                                schema = generateValueSchema(decodeURIComponent(kvp[1]));
                            parameters.push({
                                name: decodeURIComponent(kvp[0]),
                                in: 'formData',
                                description: kvp[0],
                                'x-ms-summary': kvp[0],
                                type: schema.type,
                                required: !!schema.required
                            });
                        });
                    } else {
                        try {
                           var json = JSON.parse(request.postData.text);
                           parameters.push({
                                name: '__requested_body__',
                                in: 'body',
                                description: 'request body',
                                'x-ms-summary': 'request body',
                                schema: generateResponseSchema(json)
                           });
                        } catch (e) {
                            console.error(e);
                        } 
                    }                                               
                }
                return parameters;
            }

            function generateValueSchema(obj) {
                if (Number(isInteger(obj))) {
                    return {
                        type: 'integer',
                        required: true
                    };
                } else if (Number(isFloat(obj))) {
                    return {
                        type: 'double',
                        required: true
                    };
                } else if (obj === 'true' || obj === 'false') {
                    return {
                        type: 'boolean',
                        required: true
                    };
                } else {
                    return {
                        type: 'string',
                        required: true
                    };
                }
            }
        }
    </script>
</body>
</html>